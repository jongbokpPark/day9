<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      * {
        padding: 0;
        margin: 0;
      }
      #wrapper {
        width: 1200px;
        height: 900px;
        margin: 50px auto 0;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
      }
      #control {
        width: 200px;
        height: 100%;
        background: navy;
      }
      #content {
        width: 1000px;
        height: 100%;
        /* background: rgb(121, 121, 255); */
        position: relative;
        overflow: hidden;
        border: 1px solid black;
        box-sizing: border-box;
      }
      #keyword {
        width: 100%;
        height: 50px;
        font-size: 26px;
        text-align: center;
        box-sizing: border-box;
      }
      #hp-box {
        width: 100%;
        height: 200px;
        /* background: pink; */
        position: relative;
        margin-top: 30px;
      }
      #bt,
      select,
      button {
        width: 100%;
        height: 40px;
        font-size: 22px;
        margin-top: 5px;
      }
    </style>

    <script src="../lib/common.js"></script>
    <script>
      // 1. 게임에 사용할 단어들을 배열화 시켜놓아야,
      // 1-1) 동시에 내여오게(반복문) 처리
      // 1-2) 입력 단어와 하강중인 단어와의 일치여부 판단(반복문)
      let word = [
        [
          "강아지",
          "고양이",
          "닭",
          "송아지",
          "돼지",
          "오리",
          "칠면조",
          "족제비",
          "부엉이",
          "여우",
        ],
        [
          "사과",
          "포도",
          "바나나",
          "거봉",
          "딸기",
          "오랜지",
          "할라봉",
          "무화과",
          "청포도",
          "복숭아",
        ],
        [
          "서울",
          "경기",
          "인천",
          "부산",
          "대전",
          "대구",
          "울산",
          "경주",
          "강릉",
          "제주도",
        ],
      ];

      let content;
      let keyWord;
      let hpBox;
      let bt;
      let level; // 게임의 스테이지를 결정짓는 변수
      let bgArray = ["Venice1.jpg", "Venice2.jpg", "Venice3.jpg"];

      let spanArray = []; // span에 정보를 담기위한 배열, 이 배열이 span을 제어한다.
      let velY = 5;
      let stage = 0; // 9. 현재사용자가 게임중인 스테이지 레벨 값

      // 9. 배열을 제어하려고.. hp 2차원구조이므로, 배열 또한
      // 9. 2차원으로 짝을 맞추면
      let hpArray = []; // 9. 생성된 hp박스를 보관해놓을 배열,

      let flag = false;

      let hpRowIndex = 0; // hp를 이차원배열의 층수 접근
      let hpColIndex = 0; // hp를 이차원배열의 호수 접근

      // 3. 배열에 들어있는 텍스트 정보를, 실제 움직이는 span화시켜
      // 3. 제어할 수 있도록 만들기
      function createWord() {
        stage = parseInt(level.value);

        for (let i = 0; i < word[stage].length; i++) {
          let span = document.createElement("span");
          span.innerText = word[stage][i];
          span.style.position = "absolute";
          span.style.left = i * 100 + "px";
          span.style.top = getRandomByRange(-100, 101) + "px";

          // content에 부착
          content.appendChild(span);
          spanArray.push(span);
        }
      }

      // 4. 텍스트 박스에 입려한 값과, 화면에 등장하는 모든 단어와 서로
      // 4. 일치하는지 여부를 따져보고, 일치하면 화면에 단어제거, 점수증가
      function enterKey() {
        // 5. 화면에 존재하는 span의 수만큼 반복문 수행하면서
        // 5. 입력한 텍스트값과 일치 여부를 따져보자..
        if (event.keyCode == 13) {
          for (let i = 0; i < spanArray.length; i++) {
            if (keyword.value == spanArray[i].innerText) {
              //   console.log("단어 일치 발견", i, "번쨰");
              //8. 화면에서 일치하는 해당 span 제거하기
              content.removeChild(spanArray[i]);

              // spanArray배열에서도 제거해야함
              // splice(몇번째, 몇개); splice(index, i)
              spanArray.splice(i, 1);
            }
          }
        }
      }

      function down() {
        // 모든 단어가 내려오게
        for (let z = 0; z < spanArray.length; z++) {
          // 10. 단어의 위치를 내려오게..
          spanArray[z].style.top =
            // 10. 단어의 위치를 내려오게..
            parseInt(spanArray[z].style.top) + velY + "px";
        }
      }

      // 9. hp를 표현하는 9개의 사각형을 생성하여, hpbox에 부착
      function createHp() {
        // 층
        for (let a = 0; a < 3; a++) {
          let arr = []; // arr 변수는 펑션 크리에이트 에이치피 안 첫번째 포문 안에 층에 관련

          // 호
          for (let i = 0; i < 3; i++) {
            let hp = document.createElement("div");
            hp.style.width = 60 + "px";
            hp.style.height = 60 + "px";
            hp.style.background = "red";
            hp.style.position = "absolute";
            hp.style.left = 5 + 65 * i + "px";
            hp.style.top = 5 + 65 * a + "px";

            hpBox.appendChild(hp);

            arr.push(hp);
          }
          // 채워진 arr배열을, 큰 배열에 담는다.
          hpArray.push(arr);
          // console.log(hpArray);
        }
      }

      // 11. 화면에 남아 있는 단어를 대상으로, 데드라인을 넘어섰는지 판단하여
      // 11. 넘어선 경우hp를 하나 깍고, 단어도 사라지게(시각적제거 + 배열애서 제거)
      function checkDeadLine() {
        // 게임오버 체크(층2, 호2)
        if (hpRowIndex >= 2 && hpColIndex >= 2) {
          flag - false;
          alert("게임종료");
        }

        // 화면에 남아있는 단어를 대상으로 데드라인을 넘어섰는지
        //판단하여 넘어선 경우에는 hp를 하나 깎고 단어도 사라지게 만들자(시각적 그리고 배열안에서도) .
        for (let i = 0; i < spanArray.length; i++) {
          // 남은 단어 수 배열 수 만큼 반복...
          if (parseInt(spanArray[i].style.top) >= 500) {
            //시각적으로 화면에서 제거
            content.removeChild(spanArray[i]);
            //그리고 실제적으로 메모리에는 아직 남아 있으니
            //배열 안에서도 제거해야한다.
            spanArray.splice(i, 1);

            // 21. hp도 제거하자 데드라인 도달하면
            hpArray[hpRowIndex][hpColIndex].style.background = "yellow";
            hpColIndex++;

            if (hpColIndex > 2) {
              hpRowIndex++;
              hpColIndex = 0;
            }
          }
        }
      }

      // 사용자가 선택한 레벨로 게임을 시작하는 함수
      function startGame() {
        // 기존에 있는 단어들은 모두 제거
        for (let i = 0; i < spanArray.length; i++) {
          content.removeChild(spanArray[i]);
        }
        spanArray = [];

        createWord();
      }

      // 레벨의 각bg 선택
      function setBg(index) {
        content.style.backgroundImage =
          "url(../images/Venice/" + bgArray[index] + ")";
        content.style.backgroundSize = "1000px 900px";
        console.log("현재레벨은?", index);
      }

      // 단어들이 일정시간 간격을 두고 점점 내려오는 효과
      function gameLoop() {
        if (flag) {
          // 데드라인에 넘어 섰는지 판단
          checkDeadLine();
          down();
        }
      }

      // 0. 초기화
      addEventListener("load", function () {
        content = document.getElementById("content");
        keyword = document.getElementById("keyword");
        hpBox = document.getElementById("hp-box");
        bt = document.getElementById("bt");
        level = document.getElementById("level");

        bt.addEventListener("click", function () {
          flag = !flag;
          if (flag) {
            this.innerText = "pause";
          } else {
            this.innerText = "play";
          }
        });

        // createWord(); // 텍스트 생성하기
        createHp(); // hp 생성하기
        setBg(level.value); // 배경이미지 설정

        // 무언가 움직임이 있는 프로그램에서는 loop가 존재해야함
        setInterval("gameLoop()", 50);
      });
    </script>
  </head>
  <body>
    <div id="wrapper">
      <div id="control">
        <input type="text" id="keyword" onkeyup="enterKey()" />

        <div id="hp-box"></div>

        <button onclick="startGame()">게임시작</button>
        <button id="bt">Play</button>

        <select name="" id="level" onchange="setBg(this.value)">
          <option value="0">레벨1</option>
          <option value="1">레벨2</option>
          <option value="2">레벨3</option>
        </select>
      </div>
      <div id="content"></div>
    </div>
  </body>
</html>
